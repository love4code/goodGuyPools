<%- include('partials/header', { title: 'Home', siteSettings }) %>

<% 
  // Get hero background image URL
  let heroBgImageUrl = '';
  if (siteSettings && siteSettings.heroBackgroundMode === 'image' && siteSettings.heroBackgroundImage) {
    if (typeof siteSettings.heroBackgroundImage === 'object' && siteSettings.heroBackgroundImage.sizes) {
      // Use fileId to access via /admin/media/image/{fileId}
      if (siteSettings.heroBackgroundImage.sizes.large?.fileId) {
        heroBgImageUrl = '/admin/media/image/' + siteSettings.heroBackgroundImage.sizes.large.fileId;
      } else if (siteSettings.heroBackgroundImage.sizes.medium?.fileId) {
        heroBgImageUrl = '/admin/media/image/' + siteSettings.heroBackgroundImage.sizes.medium.fileId;
      } else if (siteSettings.heroBackgroundImage.sizes.thumbnail?.fileId) {
        heroBgImageUrl = '/admin/media/image/' + siteSettings.heroBackgroundImage.sizes.thumbnail.fileId;
      }
    }
  }
  
  // Get hero logo URL
  let heroLogoUrl = '';
  if (siteSettings && siteSettings.heroLogo) {
    if (typeof siteSettings.heroLogo === 'object' && siteSettings.heroLogo.sizes) {
      // Use fileId to access via /admin/media/image/{fileId}
      if (siteSettings.heroLogo.sizes.medium?.fileId) {
        heroLogoUrl = '/admin/media/image/' + siteSettings.heroLogo.sizes.medium.fileId;
      } else if (siteSettings.heroLogo.sizes.large?.fileId) {
        heroLogoUrl = '/admin/media/image/' + siteSettings.heroLogo.sizes.large.fileId;
      } else if (siteSettings.heroLogo.sizes.thumbnail?.fileId) {
        heroLogoUrl = '/admin/media/image/' + siteSettings.heroLogo.sizes.thumbnail.fileId;
      }
    }
  }
%>

<% if (siteSettings && siteSettings.heroBackgroundMode === 'image' && heroBgImageUrl) { %>
  <!-- Hero Section with Image Background -->
  <section class="mb-5 position-relative" style="min-height: 500px; overflow: hidden;">
    <div class="position-absolute top-0 start-0 w-100 h-100" style="background-image: url('<%= heroBgImageUrl %>'); background-size: cover; background-position: center; z-index: 0;"></div>
    <div class="position-absolute top-0 start-0 w-100 h-100" style="background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.6)); z-index: 1;"></div>
    <div class="position-relative" style="z-index: 2; min-height: 500px; display: flex; align-items: center;">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 mx-auto text-center text-white" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.7);">
            <% if (heroLogoUrl) { %>
              <div class="mb-4">
                <img src="<%= heroLogoUrl %>" alt="<%= siteSettings.companyName || 'Logo' %>" style="max-height: 180px; max-width: 450px; object-fit: contain;">
              </div>
            <% } %>
            <% if (siteSettings.tagline && !heroLogoUrl) { %>
              <h1 class="display-4 fw-bold mb-4"><%= siteSettings.tagline %></h1>
            <% } %>
            <% if (siteSettings.companyName && !siteSettings.tagline && !heroLogoUrl) { %>
              <h1 class="display-4 fw-bold mb-4"><%= siteSettings.companyName %></h1>
            <% } %>
            <a class="btn btn-primary btn-lg shadow" href="/contact">Request a Free Quote</a>
          </div>
        </div>
      </div>
    </div>
  </section>
<% } else { %>
  <!-- Default Home Page Section (when hero is color mode or no image) -->
  <section class="mb-5">
    <div class="p-5 bg-light rounded-3 text-center">
      <% if (heroLogoUrl) { %>
        <div class="mb-4">
          <img src="<%= heroLogoUrl %>" alt="<%= siteSettings.companyName || 'Logo' %>" style="max-height: 180px; max-width: 450px; object-fit: contain;">
        </div>
      <% } %>
      <% if (!heroLogoUrl) { %>
        <h1 class="display-5 fw-bold text-primary"><%= siteSettings.companyName || 'Good Guy Pools' %></h1>
      <% } %>
      <% if (siteSettings.tagline) { %>
        <p class="lead mb-4"><%= siteSettings.tagline %></p>
      <% } else { %>
        <p class="lead mb-4">Custom Swimming Pools & Outdoor Living</p>
      <% } %>
      <a class="btn btn-primary btn-lg" href="/contact">Request a Free Quote</a>
    </div>
  </section>
<% } %>

<section class="mb-5">
  <h2 class="h3 mb-4">Our Services</h2>
  <div class="row g-4">
    <% if (services && services.length) { %> 
      <% services.forEach(s => { %>
        <div class="col-md-3">
          <div class="card h-100 text-center">
            <div class="card-body d-flex flex-column">
              <% if (s.icon) { %>
                <div class="mb-3">
                  <i class="bi <%= s.icon %>" style="font-size: 3rem; color: #3371A0;"></i>
                </div>
              <% } %>
              <h3 class="h5 mb-3"><%= s.name || s.title %></h3>
              <% if (s.shortDescription) { %>
                <p class="card-text flex-grow-1"><%= s.shortDescription %></p>
              <% } else if (s.description) { %>
                <p class="card-text flex-grow-1"><%= s.description %></p>
              <% } %>
            </div>
          </div>
        </div>
      <% }) %> 
    <% } else { %>
      <div class="col-12">
        <div class="alert alert-secondary">
          No services yet. Add some in Admin â†’ Services.
        </div>
      </div>
    <% } %>
  </div>
</section>

<section class="mb-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="h3 mb-0">Featured Projects</h2>
    <a href="/portfolio" class="btn btn-outline-primary btn-sm">View All</a>
  </div>
  <div class="row g-4">
    <% if (projects && projects.length) { %> 
      <% projects.slice(0, 4).forEach(p => { %>
        <div class="col-lg-3 col-md-6">
          <div class="card h-100">
            <% 
              let projectImageUrl = '';
              if (p.images && p.images.length > 0) {
                // If images is populated Media objects
                if (typeof p.images[0] === 'object' && p.images[0].sizes) {
                  // Support both new (fileId) and legacy (url) formats
                  if (p.images[0].sizes.medium?.fileId) {
                    projectImageUrl = '/admin/media/image/' + p.images[0].sizes.medium.fileId;
                  } else if (p.images[0].sizes.large?.fileId) {
                    projectImageUrl = '/admin/media/image/' + p.images[0].sizes.large.fileId;
                  } else if (p.images[0].sizes.thumbnail?.fileId) {
                    projectImageUrl = '/admin/media/image/' + p.images[0].sizes.thumbnail.fileId;
                  } else if (p.images[0].sizes.medium?.url) {
                    projectImageUrl = '/public/' + p.images[0].sizes.medium.url;
                  } else if (p.images[0].sizes.large?.url) {
                    projectImageUrl = '/public/' + p.images[0].sizes.large.url;
                  } else if (p.images[0].sizes.thumbnail?.url) {
                    projectImageUrl = '/public/' + p.images[0].sizes.thumbnail.url;
                  }
                } else if (typeof p.images[0] === 'string') {
                  projectImageUrl = p.images[0];
                }
              } else if (p.featuredImage) {
                projectImageUrl = p.featuredImage;
              }
            %>
            <% if (projectImageUrl) { %>
              <img
                src="<%= projectImageUrl %>"
                class="card-img-top"
                alt="<%= p.title %>"
                style="height: 200px; object-fit: cover;"
              />
            <% } %>
            <div class="card-body d-flex flex-column">
              <h3 class="h5"><%= p.title %></h3>
              <% if (p.summary) { %>
                <p class="card-text flex-grow-1"><%= p.summary %></p>
              <% } else if (p.shortDescription) { %>
                <p class="card-text flex-grow-1"><%= p.shortDescription %></p>
              <% } %>
              <a href="/portfolio/<%= p.slug %>" class="btn btn-sm btn-primary mt-auto">View Project</a>
            </div>
          </div>
        </div>
      <% }) %> 
    <% } else { %>
      <div class="col-12">
        <div class="alert alert-secondary">No featured projects yet.</div>
      </div>
    <% } %>
  </div>
</section>

<section class="mb-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="h3 mb-0">Our Products</h2>
    <a href="/products" class="btn btn-outline-primary btn-sm">View All</a>
  </div>
  <div class="row g-4">
    <% if (products && products.length) { %>
      <% products.forEach(p => { %>
        <div class="col-md-4">
          <div class="card h-100">
            <% 
              let productImgUrl = '';
              if (p.mainImage) {
                if (typeof p.mainImage === 'object' && p.mainImage.sizes) {
                  productImgUrl = p.mainImage.sizes.medium?.fileId ? '/admin/media/image/' + p.mainImage.sizes.medium.fileId :
                                  p.mainImage.sizes.large?.fileId ? '/admin/media/image/' + p.mainImage.sizes.large.fileId :
                                  p.mainImage.sizes.thumbnail?.fileId ? '/admin/media/image/' + p.mainImage.sizes.thumbnail.fileId : '';
                }
              } else if (p.image) {
                productImgUrl = p.image;
              }
            %>
            <% if (productImgUrl) { %>
              <img src="<%= productImgUrl %>" class="card-img-top" alt="<%= p.name %>" style="height:250px;object-fit:cover">
            <% } %>
            <div class="card-body d-flex flex-column">
              <h3 class="h5 card-title"><%= p.name %></h3>
              <% if (p.shortDescription) { %>
                <p class="card-text flex-grow-1"><%= p.shortDescription %></p>
              <% } %>
              <% if (p.sizes && p.sizes.length > 0) { %>
                <div class="mb-2">
                  <small class="text-muted">Available Sizes: </small>
                  <% p.sizes.forEach(size => { %>
                    <span class="badge bg-secondary me-1"><%= size %></span>
                  <% }) %>
                </div>
              <% } %>
              <a href="/products/<%= p.slug %>" class="btn btn-primary mt-auto">Request Quote</a>
            </div>
          </div>
        </div>
      <% }) %>
    <% } else { %>
      <div class="col-12">
        <div class="alert alert-secondary">No products available at this time.</div>
      </div>
    <% } %>
  </div>
</section>

<section class="mb-5">
  <div class="row text-center g-4">
    <div class="col-md-3">
      <div class="p-3 bg-light rounded">Licensed & Insured</div>
    </div>
    <div class="col-md-3">
      <div class="p-3 bg-light rounded">Free Estimates</div>
    </div>
    <div class="col-md-3">
      <div class="p-3 bg-light rounded">
        Serving <%= (siteSettings && siteSettings.serviceArea) || 'Your Area' %>
      </div>
    </div>
    <div class="col-md-3">
      <div class="p-3 bg-light rounded">Quality Craftsmanship</div>
    </div>
  </div>
</section>

<section>
  <div class="row">
    <div class="col-lg-8 mx-auto">
      <div class="card">
        <div class="card-body">
          <h2 class="h4 mb-3">Get In Touch</h2>
          <% if (success) { %>
          <div class="alert alert-success">
            Thanks! Your inquiry has been received.
          </div>
          <% } %> <% if (errors && errors.length) { %>
          <div class="alert alert-danger"><%= errors.join(', ') %></div>
          <% } %>
          <form action="/contact" method="POST" class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Name *</label>
              <input type="text" name="name" class="form-control" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">Town *</label>
              <input type="text" name="town" class="form-control" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">Phone Number *</label>
              <input
                type="tel"
                name="phoneNumber"
                class="form-control"
                required
              />
            </div>
            <div class="col-md-6">
              <label class="form-label">Email *</label>
              <input type="email" name="email" class="form-control" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">Project Type *</label>
              <select name="projectType" class="form-select" required>
                <option value="">Select...</option>
                <option>New pool construction</option>
                <option>Renovation</option>
                <option>Maintenance/Service</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label">Message</label>
              <textarea name="message" rows="4" class="form-control"></textarea>
            </div>
            <input type="text" name="honey" style="display: none" />
            <div class="col-12">
              <button class="btn btn-primary">Send Message</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>

<%- include('partials/footer', { siteSettings }) %>

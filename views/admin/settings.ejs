<%- include('../partials/admin-header', { title: 'Site Settings', currentPage: 'settings' }) %>
<form action="/admin/settings" method="POST" enctype="multipart/form-data" class="row g-3">
  <div class="col-md-6">
    <label class="form-label">Company Name</label>
    <input type="text" name="companyName" class="form-control" value="<%= settings.companyName %>">
  </div>
  <div class="col-md-6">
    <label class="form-label">Tagline</label>
    <input type="text" name="tagline" class="form-control" value="<%= settings.tagline %>">
  </div>
  <div class="col-md-12">
    <label class="form-label">Address</label>
    <input type="text" name="address" class="form-control" value="<%= settings.address %>">
  </div>
  <div class="col-md-6">
    <label class="form-label">Service Area</label>
    <input type="text" name="serviceArea" class="form-control" value="<%= settings.serviceArea %>">
  </div>
  <div class="col-md-3">
    <label class="form-label">Phone</label>
    <input type="text" name="phone" class="form-control" value="<%= settings.phone %>">
  </div>
  <div class="col-md-3">
    <label class="form-label">Email</label>
    <input type="email" name="email" class="form-control" value="<%= settings.email %>">
  </div>
  <div class="col-md-6">
    <label class="form-label">Facebook URL</label>
    <input type="url" name="facebookUrl" class="form-control" value="<%= settings.social.facebookUrl %>">
  </div>
  <div class="col-md-6">
    <label class="form-label">Instagram URL</label>
    <input type="url" name="instagramUrl" class="form-control" value="<%= settings.social.instagramUrl %>">
  </div>
  <div class="col-md-6">
    <label class="form-label">TikTok URL</label>
    <input type="url" name="tiktokUrl" class="form-control" value="<%= settings.social.tiktokUrl %>">
  </div>
  <div class="col-md-6">
    <label class="form-label">YouTube URL</label>
    <input type="url" name="youtubeUrl" class="form-control" value="<%= settings.social.youtubeUrl %>">
  </div>
  <div class="col-md-6">
    <label class="form-label">Default Title</label>
    <input type="text" name="defaultTitle" class="form-control" value="<%= settings.seo.defaultTitle %>">
  </div>
  <div class="col-md-6">
    <label class="form-label">Default Meta Description</label>
    <input type="text" name="defaultMetaDescription" class="form-control" value="<%= settings.seo.defaultMetaDescription %>">
  </div>
  <div class="col-md-12">
    <label class="form-label">Favicon</label>
    <div class="input-group mb-2">
      <input type="text" name="favicon" id="favicon" class="form-control" placeholder="Media ID or path" value="<%= settings.favicon || '' %>">
      <button class="btn btn-outline-secondary" type="button" onclick="openMediaPicker({multiple: false, callback: async function(id) { document.getElementById('favicon').value = id; await updateMediaPreview(id, document.getElementById('favicon').closest('.col-md-12'), 'thumbnail'); }})">Select from Media Library</button>
    </div>
    <input type="file" name="faviconUpload" id="faviconUpload" class="form-control" accept="image/x-icon,image/png,image/jpeg,image/gif">
    <small class="text-muted">Upload a new favicon (.ico, .png, .jpg, .gif) or select from media library</small>
    <% if (settings.favicon) { %>
      <div class="mt-2">
        <img src="<%= settings.favicon %>" alt="Favicon preview" class="img-thumbnail" style="width: 32px; height: 32px; object-fit: contain;">
      </div>
    <% } %>
  </div>
  <div class="col-md-12">
    <label class="form-label">Navbar Logo</label>
    <div class="input-group mb-2">
      <input type="text" name="logo" id="logo" class="form-control" placeholder="Media ID" value="<%= settings.navbarLogo ? (typeof settings.navbarLogo === 'object' ? settings.navbarLogo._id.toString() : settings.navbarLogo.toString()) : (settings.logo || '') %>">
      <button class="btn btn-outline-secondary" type="button" onclick="openMediaPicker({multiple: false, callback: async function(id) { document.getElementById('logo').value = id; await updateMediaPreview(id, document.getElementById('logo').closest('.col-md-12'), 'medium'); }})">Select from Media Library</button>
    </div>
    <input type="file" name="logoUpload" id="logoUpload" class="form-control" accept="image/png,image/jpeg,image/jpg,image/gif,image/svg+xml">
    <small class="text-muted">Upload a new logo (.png, .jpg, .gif, .svg) or select from media library. Recommended height: 40-60px. This logo will appear in the navbar.</small>
    <% 
      let logoPreviewUrl = '';
      if (settings.navbarLogo) {
        if (typeof settings.navbarLogo === 'object' && settings.navbarLogo.sizes) {
          logoPreviewUrl = settings.navbarLogo.sizes.medium?.url || settings.navbarLogo.sizes.large?.url || settings.navbarLogo.sizes.thumbnail?.url || '';
          if (logoPreviewUrl) logoPreviewUrl = '/public/' + logoPreviewUrl;
        }
      } else if (settings.logo) {
        logoPreviewUrl = settings.logo;
      }
    %>
    <% if (logoPreviewUrl) { %>
      <div class="mt-2">
        <img src="<%= logoPreviewUrl %>" alt="Logo preview" class="img-thumbnail" style="max-height: 60px; max-width: 200px; object-fit: contain;">
      </div>
    <% } %>
  </div>
  <div class="col-md-12">
    <label class="form-label">Default OG Image (URL)</label>
    <input type="text" name="defaultOgImage" class="form-control" value="<%= settings.seo.defaultOgImage %>">
  </div>

  <!-- Hero Section Settings -->
  <div class="col-12">
    <hr class="my-4">
    <h2 class="h5 mb-3">Home Page Hero Section</h2>
    <p class="text-muted small">Customize the hero section on your home page. If disabled, the default home page layout will be shown.</p>
  </div>

  <div class="col-md-12">
    <label class="form-label">Hero Background Mode</label>
    <select name="heroBackgroundMode" class="form-select">
      <option value="color" <%= settings.heroBackgroundMode === 'color' ? 'selected' : '' %>>Color</option>
      <option value="image" <%= settings.heroBackgroundMode === 'image' ? 'selected' : '' %>>Image</option>
    </select>
    <small class="text-muted">Choose whether to use a color or image background for the hero section</small>
  </div>

  <div class="col-md-12">
    <label class="form-label">Hero Background Image</label>
    <div class="input-group mb-2">
      <input type="text" name="heroBackgroundImage" id="heroBackgroundImage" class="form-control" placeholder="Media ID" value="<%= settings.heroBackgroundImage ? (typeof settings.heroBackgroundImage === 'object' ? settings.heroBackgroundImage._id.toString() : settings.heroBackgroundImage.toString()) : '' %>">
      <button class="btn btn-outline-secondary" type="button" onclick="openMediaPicker({multiple: false, callback: async function(id) { document.getElementById('heroBackgroundImage').value = id; await updateMediaPreview(id, document.getElementById('heroBackgroundImage').closest('.col-md-12'), 'large'); }})">Select from Media Library</button>
    </div>
    <small class="text-muted">Select an image from your media library (only used if Background Mode is "Image")</small>
    <% 
      let heroBgPreviewUrl = '';
      if (settings.heroBackgroundImage) {
        if (typeof settings.heroBackgroundImage === 'object' && settings.heroBackgroundImage.sizes) {
          heroBgPreviewUrl = settings.heroBackgroundImage.sizes.large?.url || settings.heroBackgroundImage.sizes.medium?.url || settings.heroBackgroundImage.sizes.thumbnail?.url || '';
          if (heroBgPreviewUrl) heroBgPreviewUrl = '/public/' + heroBgPreviewUrl;
        }
      }
    %>
    <% if (heroBgPreviewUrl) { %>
      <div class="mt-2">
        <img src="<%= heroBgPreviewUrl %>" alt="Hero background preview" class="img-thumbnail" style="max-width: 300px; max-height: 200px; object-fit: cover;">
      </div>
    <% } %>
  </div>

  <div class="col-md-12">
    <label class="form-label">Hero Logo</label>
    <div class="input-group mb-2">
      <input type="text" name="heroLogo" id="heroLogo" class="form-control" placeholder="Media ID" value="<%= settings.heroLogo ? (typeof settings.heroLogo === 'object' ? settings.heroLogo._id.toString() : settings.heroLogo.toString()) : '' %>">
      <button class="btn btn-outline-secondary" type="button" onclick="openMediaPicker({multiple: false, callback: async function(id) { document.getElementById('heroLogo').value = id; await updateMediaPreview(id, document.getElementById('heroLogo').closest('.col-md-12'), 'medium'); }})">Select from Media Library</button>
    </div>
    <small class="text-muted">Select a logo image (SVG recommended) for the hero section</small>
    <% 
      let heroLogoPreviewUrl = '';
      if (settings.heroLogo) {
        if (typeof settings.heroLogo === 'object' && settings.heroLogo.sizes) {
          heroLogoPreviewUrl = settings.heroLogo.sizes.medium?.url || settings.heroLogo.sizes.large?.url || settings.heroLogo.sizes.thumbnail?.url || '';
          if (heroLogoPreviewUrl) heroLogoPreviewUrl = '/public/' + heroLogoPreviewUrl;
        }
      }
    %>
    <% if (heroLogoPreviewUrl) { %>
      <div class="mt-2">
        <img src="<%= heroLogoPreviewUrl %>" alt="Hero logo preview" class="img-thumbnail" style="max-height: 60px; max-width: 200px; object-fit: contain;">
      </div>
    <% } %>
  </div>

  <!-- Theme Customization Section -->
  <div class="col-12">
    <hr class="my-4">
    <h2 class="h5 mb-3">Theme Customization</h2>
    <p class="text-muted small">Customize the appearance of your header and footer with predefined themes or custom colors.</p>
  </div>

  <div class="col-md-12">
    <label class="form-label">Theme</label>
    <select name="themeName" id="themeName" class="form-select">
      <option value="waterBlue1" <%= settings.themeName === 'waterBlue1' ? 'selected' : '' %>>Water Blue 1</option>
      <option value="waterBlue2" <%= settings.themeName === 'waterBlue2' ? 'selected' : '' %>>Water Blue 2</option>
      <option value="aqua" <%= settings.themeName === 'aqua' ? 'selected' : '' %>>Aqua</option>
      <option value="deepBlue" <%= settings.themeName === 'deepBlue' ? 'selected' : '' %>>Deep Blue</option>
      <option value="tealWave" <%= settings.themeName === 'tealWave' ? 'selected' : '' %>>Teal Wave</option>
      <option value="skyBlue" <%= settings.themeName === 'skyBlue' ? 'selected' : '' %>>Sky Blue</option>
      <option value="custom" <%= settings.themeName === 'custom' ? 'selected' : '' %>>Custom Theme</option>
    </select>
    <small class="text-muted">Select a preset theme or choose "Custom Theme" to set your own colors</small>
  </div>

  <div id="customThemeFields" style="display: <%= settings.themeName === 'custom' ? 'block' : 'none' %>;">
    <div class="col-md-12">
      <h6 class="mt-3 mb-2">Custom Theme Colors</h6>
    </div>
    <div class="col-md-6">
      <label class="form-label">Primary Color</label>
      <input type="color" name="primaryColor" class="form-control form-control-color" value="<%= settings.customTheme && settings.customTheme.primaryColor ? settings.customTheme.primaryColor : '#0d6efd' %>">
    </div>
    <div class="col-md-6">
      <label class="form-label">Secondary Color</label>
      <input type="color" name="secondaryColor" class="form-control form-control-color" value="<%= settings.customTheme && settings.customTheme.secondaryColor ? settings.customTheme.secondaryColor : '#6c757d' %>">
    </div>
    <div class="col-md-6">
      <label class="form-label">Accent Color</label>
      <input type="color" name="accentColor" class="form-control form-control-color" value="<%= settings.customTheme && settings.customTheme.accentColor ? settings.customTheme.accentColor : '#0dcaf0' %>">
    </div>
    <div class="col-md-6">
      <label class="form-label">Background Color</label>
      <input type="color" name="backgroundColor" class="form-control form-control-color" value="<%= settings.customTheme && settings.customTheme.backgroundColor ? settings.customTheme.backgroundColor : '#ffffff' %>">
    </div>
    <div class="col-md-6">
      <label class="form-label">Text Color</label>
      <input type="color" name="textColor" class="form-control form-control-color" value="<%= settings.customTheme && settings.customTheme.textColor ? settings.customTheme.textColor : '#000000' %>">
    </div>
  </div>

  <script>
    document.getElementById('themeName')?.addEventListener('change', function() {
      const customFields = document.getElementById('customThemeFields');
      if (this.value === 'custom') {
        customFields.style.display = 'block';
      } else {
        customFields.style.display = 'none';
      }
    });
  </script>

  <!-- Header Colors -->
  <div class="col-12">
    <h3 class="h6 mt-4 mb-3">Header Colors</h3>
  </div>
  <div class="col-md-6">
    <label class="form-label">Background Color</label>
    <div class="input-group">
      <input type="color" name="headerBackgroundColor" id="headerBackgroundColor" class="form-control form-control-color" value="<%= settings.theme && settings.theme.header ? settings.theme.header.backgroundColor : '#ffffff' %>">
      <input type="text" id="headerBackgroundColorText" class="form-control" value="<%= settings.theme && settings.theme.header ? settings.theme.header.backgroundColor : '#ffffff' %>">
    </div>
  </div>
  <div class="col-md-6">
    <label class="form-label">Brand Text Color</label>
    <div class="input-group">
      <input type="color" name="headerTextColor" id="headerTextColor" class="form-control form-control-color" value="<%= settings.theme && settings.theme.header ? settings.theme.header.textColor : '#0d6efd' %>">
      <input type="text" id="headerTextColorText" class="form-control" value="<%= settings.theme && settings.theme.header ? settings.theme.header.textColor : '#0d6efd' %>">
    </div>
  </div>
  <div class="col-md-6">
    <label class="form-label">Link Color</label>
    <div class="input-group">
      <input type="color" name="headerLinkColor" id="headerLinkColor" class="form-control form-control-color" value="<%= settings.theme && settings.theme.header ? settings.theme.header.linkColor : '#000000' %>">
      <input type="text" id="headerLinkColorText" class="form-control" value="<%= settings.theme && settings.theme.header ? settings.theme.header.linkColor : '#000000' %>">
    </div>
  </div>
  <div class="col-md-6">
    <label class="form-label">Link Hover Color</label>
    <div class="input-group">
      <input type="color" name="headerLinkHoverColor" id="headerLinkHoverColor" class="form-control form-control-color" value="<%= settings.theme && settings.theme.header ? settings.theme.header.linkHoverColor : '#0d6efd' %>">
      <input type="text" id="headerLinkHoverColorText" class="form-control" value="<%= settings.theme && settings.theme.header ? settings.theme.header.linkHoverColor : '#0d6efd' %>">
    </div>
  </div>

  <!-- Footer Colors -->
  <div class="col-12">
    <h3 class="h6 mt-4 mb-3">Footer Colors</h3>
  </div>
  <div class="col-md-6">
    <label class="form-label">Background Color</label>
    <div class="input-group">
      <input type="color" name="footerBackgroundColor" id="footerBackgroundColor" class="form-control form-control-color" value="<%= settings.theme && settings.theme.footer ? settings.theme.footer.backgroundColor : '#ffffff' %>">
      <input type="text" id="footerBackgroundColorText" class="form-control" value="<%= settings.theme && settings.theme.footer ? settings.theme.footer.backgroundColor : '#ffffff' %>">
    </div>
  </div>
  <div class="col-md-6">
    <label class="form-label">Text Color</label>
    <div class="input-group">
      <input type="color" name="footerTextColor" id="footerTextColor" class="form-control form-control-color" value="<%= settings.theme && settings.theme.footer ? settings.theme.footer.textColor : '#6c757d' %>">
      <input type="text" id="footerTextColorText" class="form-control" value="<%= settings.theme && settings.theme.footer ? settings.theme.footer.textColor : '#6c757d' %>">
    </div>
  </div>
  <div class="col-md-6">
    <label class="form-label">Link Color</label>
    <div class="input-group">
      <input type="color" name="footerLinkColor" id="footerLinkColor" class="form-control form-control-color" value="<%= settings.theme && settings.theme.footer ? settings.theme.footer.linkColor : '#0d6efd' %>">
      <input type="text" id="footerLinkColorText" class="form-control" value="<%= settings.theme && settings.theme.footer ? settings.theme.footer.linkColor : '#0d6efd' %>">
    </div>
  </div>
  <div class="col-md-6">
    <label class="form-label">Link Hover Color</label>
    <div class="input-group">
      <input type="color" name="footerLinkHoverColor" id="footerLinkHoverColor" class="form-control form-control-color" value="<%= settings.theme && settings.theme.footer ? settings.theme.footer.linkHoverColor : '#0a58ca' %>">
      <input type="text" id="footerLinkHoverColorText" class="form-control" value="<%= settings.theme && settings.theme.footer ? settings.theme.footer.linkHoverColor : '#0a58ca' %>">
    </div>
  </div>
  <div class="col-md-6">
    <label class="form-label">Border Color</label>
    <div class="input-group">
      <input type="color" name="footerBorderColor" id="footerBorderColor" class="form-control form-control-color" value="<%= settings.theme && settings.theme.footer ? settings.theme.footer.borderColor : '#dee2e6' %>">
      <input type="text" id="footerBorderColorText" class="form-control" value="<%= settings.theme && settings.theme.footer ? settings.theme.footer.borderColor : '#dee2e6' %>">
    </div>
  </div>

  <div class="col-12">
    <button class="btn btn-primary">Save Settings</button>
  </div>
</form>

<script>
  const presets = {
    'default': {
      header: { backgroundColor: '#ffffff', textColor: '#0d6efd', linkColor: '#000000', linkHoverColor: '#0d6efd' },
      footer: { backgroundColor: '#ffffff', textColor: '#6c757d', linkColor: '#0d6efd', linkHoverColor: '#0a58ca', borderColor: '#dee2e6' }
    },
    'ocean-blue': {
      header: { backgroundColor: '#006994', textColor: '#ffffff', linkColor: '#ffffff', linkHoverColor: '#b3e5fc' },
      footer: { backgroundColor: '#003d5b', textColor: '#ffffff', linkColor: '#80d6ff', linkHoverColor: '#b3e5fc', borderColor: '#006994' }
    },
    'sky-blue': {
      header: { backgroundColor: '#87ceeb', textColor: '#ffffff', linkColor: '#ffffff', linkHoverColor: '#003d5b' },
      footer: { backgroundColor: '#5fb3d3', textColor: '#ffffff', linkColor: '#ffffff', linkHoverColor: '#003d5b', borderColor: '#87ceeb' }
    },
    'navy-blue': {
      header: { backgroundColor: '#001f3f', textColor: '#ffffff', linkColor: '#ffffff', linkHoverColor: '#7fdbff' },
      footer: { backgroundColor: '#001122', textColor: '#ffffff', linkColor: '#7fdbff', linkHoverColor: '#b3e5fc', borderColor: '#001f3f' }
    },
    'royal-blue': {
      header: { backgroundColor: '#4169e1', textColor: '#ffffff', linkColor: '#ffffff', linkHoverColor: '#e6f2ff' },
      footer: { backgroundColor: '#1e3a8a', textColor: '#ffffff', linkColor: '#93c5fd', linkHoverColor: '#dbeafe', borderColor: '#4169e1' }
    },
    'dark': {
      header: { backgroundColor: '#212529', textColor: '#ffffff', linkColor: '#ffffff', linkHoverColor: '#0d6efd' },
      footer: { backgroundColor: '#1a1d20', textColor: '#adb5bd', linkColor: '#6ea8fe', linkHoverColor: '#9ec5fe', borderColor: '#495057' }
    },
    'light': {
      header: { backgroundColor: '#f8f9fa', textColor: '#0d6efd', linkColor: '#495057', linkHoverColor: '#0d6efd' },
      footer: { backgroundColor: '#ffffff', textColor: '#6c757d', linkColor: '#0d6efd', linkHoverColor: '#0a58ca', borderColor: '#dee2e6' }
    }
  };

  function applyPreset() {
    const preset = document.getElementById('themePreset').value;
    if (preset === 'custom') return; // Don't override custom colors
    
    const theme = presets[preset];
    if (theme) {
      // Header colors
      document.getElementById('headerBackgroundColor').value = theme.header.backgroundColor;
      document.getElementById('headerBackgroundColorText').value = theme.header.backgroundColor;
      document.getElementById('headerTextColor').value = theme.header.textColor;
      document.getElementById('headerTextColorText').value = theme.header.textColor;
      document.getElementById('headerLinkColor').value = theme.header.linkColor;
      document.getElementById('headerLinkColorText').value = theme.header.linkColor;
      document.getElementById('headerLinkHoverColor').value = theme.header.linkHoverColor;
      document.getElementById('headerLinkHoverColorText').value = theme.header.linkHoverColor;
      
      // Footer colors
      document.getElementById('footerBackgroundColor').value = theme.footer.backgroundColor;
      document.getElementById('footerBackgroundColorText').value = theme.footer.backgroundColor;
      document.getElementById('footerTextColor').value = theme.footer.textColor;
      document.getElementById('footerTextColorText').value = theme.footer.textColor;
      document.getElementById('footerLinkColor').value = theme.footer.linkColor;
      document.getElementById('footerLinkColorText').value = theme.footer.linkColor;
      document.getElementById('footerLinkHoverColor').value = theme.footer.linkHoverColor;
      document.getElementById('footerLinkHoverColorText').value = theme.footer.linkHoverColor;
      document.getElementById('footerBorderColor').value = theme.footer.borderColor;
      document.getElementById('footerBorderColorText').value = theme.footer.borderColor;
    }
  }

  // Sync color picker with text input
  document.getElementById('headerBackgroundColor').addEventListener('change', function() {
    document.getElementById('headerBackgroundColorText').value = this.value;
  });
  document.getElementById('headerTextColor').addEventListener('change', function() {
    document.getElementById('headerTextColorText').value = this.value;
  });
  document.getElementById('headerLinkColor').addEventListener('change', function() {
    document.getElementById('headerLinkColorText').value = this.value;
  });
  document.getElementById('headerLinkHoverColor').addEventListener('change', function() {
    document.getElementById('headerLinkHoverColorText').value = this.value;
  });
  document.getElementById('footerBackgroundColor').addEventListener('change', function() {
    document.getElementById('footerBackgroundColorText').value = this.value;
  });
  document.getElementById('footerTextColor').addEventListener('change', function() {
    document.getElementById('footerTextColorText').value = this.value;
  });
  document.getElementById('footerLinkColor').addEventListener('change', function() {
    document.getElementById('footerLinkColorText').value = this.value;
  });
  document.getElementById('footerLinkHoverColor').addEventListener('change', function() {
    document.getElementById('footerLinkHoverColorText').value = this.value;
  });
  document.getElementById('footerBorderColor').addEventListener('change', function() {
    document.getElementById('footerBorderColorText').value = this.value;
  });

  // Sync text input with color picker
  document.getElementById('headerBackgroundColorText').addEventListener('change', function() {
    if (/^#[0-9A-F]{6}$/i.test(this.value)) {
      document.getElementById('headerBackgroundColor').value = this.value;
    }
  });
  document.getElementById('headerTextColorText').addEventListener('change', function() {
    if (/^#[0-9A-F]{6}$/i.test(this.value)) {
      document.getElementById('headerTextColor').value = this.value;
    }
  });
  document.getElementById('headerLinkColorText').addEventListener('change', function() {
    if (/^#[0-9A-F]{6}$/i.test(this.value)) {
      document.getElementById('headerLinkColor').value = this.value;
    }
  });
  document.getElementById('headerLinkHoverColorText').addEventListener('change', function() {
    if (/^#[0-9A-F]{6}$/i.test(this.value)) {
      document.getElementById('headerLinkHoverColor').value = this.value;
    }
  });
  document.getElementById('footerBackgroundColorText').addEventListener('change', function() {
    if (/^#[0-9A-F]{6}$/i.test(this.value)) {
      document.getElementById('footerBackgroundColor').value = this.value;
    }
  });
  document.getElementById('footerTextColorText').addEventListener('change', function() {
    if (/^#[0-9A-F]{6}$/i.test(this.value)) {
      document.getElementById('footerTextColor').value = this.value;
    }
  });
  document.getElementById('footerLinkColorText').addEventListener('change', function() {
    if (/^#[0-9A-F]{6}$/i.test(this.value)) {
      document.getElementById('footerLinkColor').value = this.value;
    }
  });
  document.getElementById('footerLinkHoverColorText').addEventListener('change', function() {
    if (/^#[0-9A-F]{6}$/i.test(this.value)) {
      document.getElementById('footerLinkHoverColor').value = this.value;
    }
  });
  document.getElementById('footerBorderColorText').addEventListener('change', function() {
    if (/^#[0-9A-F]{6}$/i.test(this.value)) {
      document.getElementById('footerBorderColor').value = this.value;
    }
  });
</script>

<!-- Media Modal for Hero Image Selection -->
<div class="modal fade" id="mediaModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Select Media</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="mediaGrid" class="row g-3"></div>
      </div>
    </div>
  </div>
</div>

<script>
  let targetInput = null;
  async function openMediaModal(targetId) {
    targetInput = document.getElementById(targetId);
    const grid = document.getElementById('mediaGrid');
    grid.innerHTML = '<div class="text-center py-5">Loading...</div>';
    try {
      const res = await fetch('/admin/media/api/list');
      const items = await res.json();
      grid.innerHTML = items.map(m => `
        <div class="col-md-3">
          <div class="card h-100" onclick="selectMedia('${m.filePath}', '${targetId}')" style="cursor: pointer;">
            <img src="${m.filePath}" class="card-img-top" style="object-fit:cover;height:180px">
            <div class="card-body small">
              <div class="fw-semibold">${m.title || m.originalFilename}</div>
              <div class="text-muted">${m.filePath}</div>
            </div>
          </div>
        </div>
      `).join('');
      new bootstrap.Modal(document.getElementById('mediaModal')).show();
    } catch (error) {
      grid.innerHTML = '<div class="text-center py-5 text-danger">Error loading media. Please try again.</div>';
    }
  }
  
  function selectMedia(path, targetId) {
    const input = document.getElementById(targetId);
    if (input) {
      input.value = path;
      // Update preview if it's the hero image
      if (targetId === 'heroImage') {
        const preview = input.parentElement.nextElementSibling;
        if (preview && preview.classList.contains('mt-2')) {
          preview.innerHTML = `<img src="${path}" alt="Hero preview" class="img-thumbnail" style="max-width: 300px; max-height: 200px; object-fit: cover;">`;
        } else {
          // Create preview if it doesn't exist
          const previewDiv = document.createElement('div');
          previewDiv.className = 'mt-2';
          previewDiv.innerHTML = `<img src="${path}" alt="Hero preview" class="img-thumbnail" style="max-width: 300px; max-height: 200px; object-fit: cover;">`;
          input.parentElement.parentElement.appendChild(previewDiv);
        }
      }
      // Update preview if it's the favicon
      if (targetId === 'favicon') {
        const faviconSection = input.parentElement.parentElement;
        let preview = faviconSection.querySelector('.mt-2');
        if (preview) {
          preview.innerHTML = `<img src="${path}" alt="Favicon preview" class="img-thumbnail" style="width: 32px; height: 32px; object-fit: contain;">`;
        } else {
          // Create preview if it doesn't exist
          const previewDiv = document.createElement('div');
          previewDiv.className = 'mt-2';
          previewDiv.innerHTML = `<img src="${path}" alt="Favicon preview" class="img-thumbnail" style="width: 32px; height: 32px; object-fit: contain;">`;
          faviconSection.appendChild(previewDiv);
        }
      }
      // Update preview if it's the logo
      if (targetId === 'logo') {
        const logoSection = input.parentElement.parentElement;
        let preview = logoSection.querySelector('.mt-2');
        if (preview) {
          preview.innerHTML = `<img src="${path}" alt="Logo preview" class="img-thumbnail" style="max-height: 60px; max-width: 200px; object-fit: contain;">`;
        } else {
          // Create preview if it doesn't exist
          const previewDiv = document.createElement('div');
          previewDiv.className = 'mt-2';
          previewDiv.innerHTML = `<img src="${path}" alt="Logo preview" class="img-thumbnail" style="max-height: 60px; max-width: 200px; object-fit: contain;">`;
          logoSection.appendChild(previewDiv);
        }
      }
    }
    bootstrap.Modal.getInstance(document.getElementById('mediaModal')).hide();
  }
</script>
<%- include('../partials/admin-footer') %>



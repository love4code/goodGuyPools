<%- include('../partials/admin-header', { title: 'Media Library', currentPage: 'media' }) %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="h4 mb-0">Media Library</h2>
  <div id="bulkActions" style="display: none;">
    <button type="button" class="btn btn-danger" id="bulkDeleteBtn">
      <i class="bi bi-trash"></i> Delete Selected (<span id="selectedCount">0</span>)
    </button>
  </div>
</div>

<div class="row g-4">
  <div class="col-lg-4">
    <div class="card">
      <div class="card-body">
        <h2 class="h5 mb-3">Upload Images</h2>
        <form id="uploadForm" class="vstack gap-3">
          <div>
            <label class="form-label">Images * (up to 20)</label>
            <input type="file" id="imageInput" name="images" class="form-control" accept="image/*" multiple required>
            <small class="text-muted">Select up to 20 images to upload</small>
          </div>
          <div>
            <label class="form-label">Title</label>
            <input type="text" name="title" class="form-control">
          </div>
          <div>
            <label class="form-label">Alt Text</label>
            <input type="text" name="altText" class="form-control">
          </div>
          <div>
            <label class="form-label">Tags (comma separated)</label>
            <input type="text" name="tags" class="form-control">
          </div>
          <button type="submit" class="btn btn-primary" id="uploadBtn">
            <i class="bi bi-upload"></i> Upload
          </button>
        </form>
        
        <!-- Upload Progress -->
        <div id="uploadProgress" style="display: none;" class="mt-3">
          <div class="mb-2">
            <strong>Uploading...</strong>
          </div>
          <div id="fileProgressList"></div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-8">
    <% if (items && items.length) { %>
      <div class="mb-3">
        <label class="form-check">
          <input type="checkbox" class="form-check-input" id="selectAll">
          <span class="form-check-label">Select All</span>
        </label>
      </div>
    <% } %>
    <div class="row g-3" id="mediaGrid">
      <% if (items && items.length) { %>
        <% items.forEach(m => { %>
          <div class="col-md-4">
            <div class="card h-100">
              <div class="position-relative">
                <div class="position-absolute top-0 start-0 m-2">
                  <input type="checkbox" class="form-check-input media-checkbox" value="<%= m._id %>" data-media-id="<%= m._id %>">
                </div>
                <% 
                  // Helper to get image URL - supports both new (fileId) and legacy (url) formats
                  let imageUrl = '';
                  if (m.sizes?.thumbnail?.fileId) {
                    imageUrl = '/admin/media/image/' + m.sizes.thumbnail.fileId;
                  } else if (m.sizes?.medium?.fileId) {
                    imageUrl = '/admin/media/image/' + m.sizes.medium.fileId;
                  } else if (m.sizes?.large?.fileId) {
                    imageUrl = '/admin/media/image/' + m.sizes.large.fileId;
                  } else if (m.sizes?.thumbnail?.url) {
                    imageUrl = '/public/' + m.sizes.thumbnail.url;
                  } else if (m.sizes?.medium?.url) {
                    imageUrl = '/public/' + m.sizes.medium.url;
                  } else if (m.sizes?.large?.url) {
                    imageUrl = '/public/' + m.sizes.large.url;
                  }
                %>
                <img src="<%= imageUrl || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'300\' height=\'180\'%3E%3Crect fill=\'%23ddd\' width=\'300\' height=\'180\'/%3E%3Ctext fill=\'%23999\' font-family=\'sans-serif\' font-size=\'14\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\'%3EImage not found%3C/text%3E%3C/svg%3E' %>" 
                     class="card-img-top" 
                     style="object-fit:cover;height:180px" 
                     alt="<%= m.altText || m.title || m.originalFilename %>"
                     onerror="if (this.src.indexOf('data:') === -1) { this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'300\' height=\'180\'%3E%3Crect fill=\'%23ddd\' width=\'300\' height=\'180\'/%3E%3Ctext fill=\'%23999\' font-family=\'sans-serif\' font-size=\'14\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\'%3EImage not found%3C/text%3E%3C/svg%3E'; this.onerror=null; }">
              </div>
              <div class="card-body">
                <div class="small fw-semibold"><%= m.title || m.originalFilename %></div>
                <div class="text-muted small">
                  <% if (m.sizes?.large) { %>
                    Large: <%= m.sizes.large.width %>x<%= m.sizes.large.height %> (<%= m.sizes.large.sizeInKb %>KB)
                  <% } %>
                </div>
                <div class="mt-2 d-flex gap-2">
                  <a href="/admin/media/<%= m._id %>/edit" class="btn btn-sm btn-outline-primary">Edit</a>
                  <form action="/admin/media/<%= m._id %>/delete" method="POST" class="d-inline delete-form" data-media-id="<%= m._id %>">
                    <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete this image?')">Delete</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        <% }) %>
      <% } else { %>
        <div class="col-12">
          <div class="alert alert-secondary">No media yet. Upload some images to get started.</div>
        </div>
      <% } %>
    </div>
  </div>
</div>

<script>
document.getElementById('uploadForm')?.addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const files = document.getElementById('imageInput').files;
  
  if (files.length === 0) {
    alert('Please select at least one image');
    return;
  }
  
  if (files.length > 20) {
    alert('Maximum 20 images allowed');
    return;
  }
  
  // Create FormData manually to avoid duplicate file entries
  const formData = new FormData();
  
  // Add files to FormData (only once)
  for (let i = 0; i < files.length; i++) {
    formData.append('images', files[i]);
  }
  
  // Add other form fields
  const title = this.querySelector('[name="title"]').value;
  const altText = this.querySelector('[name="altText"]').value;
  const tags = this.querySelector('[name="tags"]').value;
  
  if (title) formData.append('title', title);
  if (altText) formData.append('altText', altText);
  if (tags) formData.append('tags', tags);
  
  const uploadBtn = document.getElementById('uploadBtn');
  const uploadProgress = document.getElementById('uploadProgress');
  const fileProgressList = document.getElementById('fileProgressList');
  
  uploadBtn.disabled = true;
  uploadProgress.style.display = 'block';
  fileProgressList.innerHTML = '';
  
  // Create progress bars for each file
  const progressBars = {};
  for (let i = 0; i < files.length; i++) {
    const fileName = files[i].name;
    const progressHtml = `
      <div class="mb-2" data-file="${fileName}">
        <div class="d-flex justify-content-between mb-1">
          <small>${fileName}</small>
          <small class="progress-text">0%</small>
        </div>
        <div class="progress" style="height: 20px;">
          <div class="progress-bar" role="progressbar" style="width: 0%">0%</div>
        </div>
      </div>
    `;
    fileProgressList.insertAdjacentHTML('beforeend', progressHtml);
    progressBars[fileName] = fileProgressList.querySelector(`[data-file="${fileName}"] .progress-bar`);
  }
  
  try {
    const xhr = new XMLHttpRequest();
    
    // Track upload progress
    xhr.upload.addEventListener('progress', function(e) {
      if (e.lengthComputable) {
        const percentComplete = Math.round((e.loaded / e.total) * 100);
        // Update all progress bars (since we can't track individual files with XHR)
        Object.values(progressBars).forEach(bar => {
          bar.style.width = percentComplete + '%';
          bar.textContent = percentComplete + '%';
          bar.parentElement.previousElementSibling.querySelector('.progress-text').textContent = percentComplete + '%';
        });
      }
    });
    
    xhr.addEventListener('load', function() {
      if (xhr.status === 200 || xhr.status === 302) {
        // Success - reload page
        window.location.href = '/admin/media';
      } else {
        alert('Upload failed. Please try again.');
        uploadBtn.disabled = false;
        uploadProgress.style.display = 'none';
      }
    });
    
    xhr.addEventListener('error', function() {
      alert('Upload error. Please try again.');
      uploadBtn.disabled = false;
      uploadProgress.style.display = 'none';
    });
    
    xhr.open('POST', '/admin/media/upload-multiple');
    xhr.send(formData);
  } catch (error) {
    console.error('Upload error:', error);
    alert('Upload error. Please try again.');
    uploadBtn.disabled = false;
    uploadProgress.style.display = 'none';
  }
});

// Bulk delete functionality
(function() {
  const selectAllCheckbox = document.getElementById('selectAll');
  let mediaCheckboxes = document.querySelectorAll('.media-checkbox');
  const bulkActions = document.getElementById('bulkActions');
  const selectedCount = document.getElementById('selectedCount');
  const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');

  // Make updateBulkActions accessible globally
  window.updateBulkActions = function() {
    // Refresh checkbox list
    mediaCheckboxes = document.querySelectorAll('.media-checkbox');
    const checked = document.querySelectorAll('.media-checkbox:checked');
    const count = checked.length;
    
    if (count > 0) {
      bulkActions.style.display = 'block';
      selectedCount.textContent = count;
    } else {
      bulkActions.style.display = 'none';
    }
    
    // Update select all checkbox state
    if (selectAllCheckbox) {
      selectAllCheckbox.checked = count === mediaCheckboxes.length && mediaCheckboxes.length > 0;
      selectAllCheckbox.indeterminate = count > 0 && count < mediaCheckboxes.length;
    }
  }

  // Select all checkbox
  if (selectAllCheckbox) {
    selectAllCheckbox.addEventListener('change', function() {
      mediaCheckboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
      });
      window.updateBulkActions();
    });
  }

  // Individual checkboxes
  mediaCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', window.updateBulkActions);
  });

  // Bulk delete button
  if (bulkDeleteBtn) {
    bulkDeleteBtn.addEventListener('click', function() {
      const checked = document.querySelectorAll('.media-checkbox:checked');
      const ids = Array.from(checked).map(cb => cb.value);
      
      if (ids.length === 0) {
        alert('Please select at least one image to delete');
        return;
      }
      
      if (!confirm(`Are you sure you want to delete ${ids.length} image(s)? This action cannot be undone.`)) {
        return;
      }
      
      // Disable button and show loading state
      bulkDeleteBtn.disabled = true;
      bulkDeleteBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Deleting...';
      
      // Send delete request
      fetch('/admin/media/bulk-delete', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ ids: ids })
      })
      .then(response => {
        if (response.ok || response.status === 302) {
          // Remove deleted cards from DOM immediately
          ids.forEach(id => {
            const checkbox = document.querySelector(`.media-checkbox[value="${id}"]`);
            if (checkbox) {
              const card = checkbox.closest('.col-md-4');
              if (card) {
                card.style.transition = 'opacity 0.3s';
                card.style.opacity = '0';
                setTimeout(() => {
                  card.remove();
                  // Update bulk actions
                  if (window.updateBulkActions) window.updateBulkActions();
                }, 300);
              }
            }
          });
          
          // Reload page after a short delay to ensure UI is updated
          setTimeout(() => {
            window.location.href = '/admin/media';
          }, 500);
        } else {
          throw new Error('Delete failed');
        }
      })
      .catch(error => {
        console.error('Delete error:', error);
        alert('Error deleting images. Please try again.');
        bulkDeleteBtn.disabled = false;
        bulkDeleteBtn.innerHTML = '<i class="bi bi-trash"></i> Delete Selected (<span id="selectedCount">' + ids.length + '</span>)';
      });
    });
  }

  // Initial update
  window.updateBulkActions();
})();

// Handle individual delete forms with AJAX to remove cards immediately
document.querySelectorAll('.delete-form').forEach(form => {
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (!confirm('Delete this image?')) {
      return;
    }
    
    const mediaId = this.dataset.mediaId;
    const card = this.closest('.col-md-4');
    const deleteBtn = this.querySelector('button[type="submit"]');
    
    // Disable button and show loading
    deleteBtn.disabled = true;
    deleteBtn.textContent = 'Deleting...';
    
    try {
      const formData = new FormData(this);
      const response = await fetch(this.action, {
        method: 'POST',
        body: formData
      });
      
      if (response.ok || response.status === 302) {
        // Remove card from DOM immediately
        if (card) {
          card.style.transition = 'opacity 0.3s';
          card.style.opacity = '0';
          setTimeout(() => {
          card.remove();
          // Refresh checkbox list and update bulk actions
          const mediaCheckboxes = document.querySelectorAll('.media-checkbox');
          if (window.updateBulkActions) window.updateBulkActions();
          }, 300);
        } else {
          // Fallback to page reload
          window.location.href = '/admin/media';
        }
      } else {
        throw new Error('Delete failed');
      }
    } catch (error) {
      console.error('Delete error:', error);
      alert('Error deleting image. Please try again.');
      deleteBtn.disabled = false;
      deleteBtn.textContent = 'Delete';
    }
  });
});
</script>

<%- include('../partials/admin-footer') %>

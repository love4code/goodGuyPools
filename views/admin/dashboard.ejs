<%- include('../partials/admin-header', { title: 'Dashboard', currentPage: 'dashboard' }) %>

<div class="mb-4">
  <div class="d-flex justify-content-between align-items-center">
    <h2 class="h4 mb-0">Dashboard Overview</h2>
    <div class="d-flex gap-2">
      <a href="/admin/products/new" class="btn btn-sm btn-primary">
        <i class="bi bi-plus-circle"></i> Add Product
      </a>
      <a href="/admin/projects/new" class="btn btn-sm btn-primary">
        <i class="bi bi-plus-circle"></i> Add Project
      </a>
      <a href="/admin/services/new" class="btn btn-sm btn-primary">
        <i class="bi bi-plus-circle"></i> Add Service
      </a>
      <a href="/admin/media" class="btn btn-sm btn-outline-primary">
        <i class="bi bi-upload"></i> Upload Media
      </a>
    </div>
  </div>
</div>

<div class="row g-3 mb-4">
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <div class="display-6"><%= stats.productCount || 0 %></div>
        <div class="text-muted">Products</div>
        <a href="/admin/products" class="btn btn-sm btn-outline-primary mt-2">View All</a>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <div class="display-6"><%= stats.projectCount || 0 %></div>
        <div class="text-muted">Projects</div>
        <a href="/admin/projects" class="btn btn-sm btn-outline-primary mt-2">View All</a>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <div class="display-6"><%= stats.serviceCount || 0 %></div>
        <div class="text-muted">Services</div>
        <a href="/admin/services" class="btn btn-sm btn-outline-primary mt-2">View All</a>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <div class="display-6"><%= stats.mediaCount || 0 %></div>
        <div class="text-muted">Media Items</div>
        <a href="/admin/media" class="btn btn-sm btn-outline-primary mt-2">View All</a>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mb-4">
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <div class="display-6"><%= stats.customerCount || 0 %></div>
        <div class="text-muted">Customers</div>
        <a href="/admin/customers" class="btn btn-sm btn-outline-primary mt-2">View All</a>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <div class="display-6"><%= stats.saleCount || 0 %></div>
        <div class="text-muted">Total Sales</div>
        <a href="/admin/sales" class="btn btn-sm btn-outline-primary mt-2">View All</a>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <div class="h4 text-success">$<%= (stats.totalSalesAmount || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></div>
        <div class="text-muted">Total Revenue</div>
        <div class="mt-2">
          <small class="text-success">Paid: $<%= (stats.paidSalesAmount || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></small><br>
          <small class="text-warning">Unpaid: $<%= (stats.unpaidSalesAmount || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></small>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <div class="display-6"><%= stats.inquiryCount || 0 %></div>
        <div class="text-muted">Inquiries</div>
        <a href="/admin/inquiries" class="btn btn-sm btn-outline-primary mt-2">View All</a>
      </div>
    </div>
  </div>
</div>

<div class="row g-4">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h2 class="h5 mb-0">Recent Inquiries</h2>
        <a href="/admin/inquiries" class="btn btn-sm btn-outline-secondary">View All</a>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Product</th>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Size</th>
                <th>Description</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% if (recentInquiries && recentInquiries.length) { %>
                <% recentInquiries.forEach(inq => { %>
                  <tr class="<%= !inq.isRead ? 'table-warning' : '' %>">
                    <td><%= new Date(inq.createdAt).toLocaleDateString() %></td>
                    <td>
                      <span class="badge bg-<%= inq.type === 'product' ? 'primary' : 'info' %>">
                        <%= inq.type %>
                      </span>
                    </td>
                    <td><%= inq.productName || '-' %></td>
                    <td><strong><%= inq.name %></strong></td>
                    <td><%= inq.email %></td>
                    <td><%= inq.phone %></td>
                    <td><%= inq.size || '-' %></td>
                    <td>
                      <%= inq.description ? (inq.description.length > 50 ? inq.description.substring(0, 50) + '...' : inq.description) : '-' %>
                    </td>
                    <td>
                      <a href="/admin/inquiries/<%= inq._id %>" class="btn btn-sm btn-outline-primary">
                        View
                      </a>
                    </td>
                  </tr>
                <% }) %>
              <% } else { %>
                <tr>
                  <td colspan="9" class="text-center text-muted">No inquiries yet.</td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Profit Charts Section -->
<div class="row g-4 mb-4">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h2 class="h5 mb-0">Profit Analytics</h2>
        <div class="d-flex gap-2 align-items-center">
          <select id="filterCustomer" class="form-select form-select-sm" style="width: 200px;">
            <option value="">All Customers</option>
            <% if (customers && customers.length) { %>
              <% customers.forEach(c => { %>
                <option value="<%= c._id %>"><%= c.name %></option>
              <% }) %>
            <% } %>
          </select>
          <select id="filterSale" class="form-select form-select-sm" style="width: 200px;">
            <option value="">All Sales</option>
            <% if (allSales && allSales.length) { %>
              <% allSales.forEach(s => { %>
                <option value="<%= s._id %>">
                  <%= s.customer ? s.customer.name : 'N/A' %> - <%= new Date(s.saleDate).toLocaleDateString() %>
                </option>
              <% }) %>
            <% } %>
          </select>
          <select id="filterYear" class="form-select form-select-sm" style="width: 120px;">
            <option value="">All Years</option>
            <% 
              const currentYear = new Date().getFullYear();
              for (let y = currentYear; y >= currentYear - 5; y--) { %>
              <option value="<%= y %>"><%= y %></option>
            <% } %>
          </select>
          <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearFilters()">Clear Filters</button>
        </div>
      </div>
      <div class="card-body">
        <ul class="nav nav-tabs mb-3" id="chartTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="monthly-tab" data-bs-toggle="tab" data-bs-target="#monthly" type="button" role="tab">
              Monthly Profit
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="yearly-tab" data-bs-toggle="tab" data-bs-target="#yearly" type="button" role="tab">
              Yearly Profit
            </button>
          </li>
        </ul>
        <div class="tab-content" id="chartTabsContent">
          <div class="tab-pane fade show active" id="monthly" role="tabpanel">
            <div id="monthlyChartContainer">
              <canvas id="monthlyProfitChart" height="80"></canvas>
            </div>
            <div id="monthlyNoData" class="text-center text-muted p-4" style="display: none;">
              No profit data available for the selected filters.
            </div>
          </div>
          <div class="tab-pane fade" id="yearly" role="tabpanel">
            <div id="yearlyChartContainer">
              <canvas id="yearlyProfitChart" height="80"></canvas>
            </div>
            <div id="yearlyNoData" class="text-center text-muted p-4" style="display: none;">
              No profit data available for the selected filters.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mt-2">
  <div class="col-md-4">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h2 class="h5 mb-0">Recent Contacts</h2>
        <a href="/admin/contacts" class="btn btn-sm btn-outline-secondary">View All</a>
      </div>
      <div class="card-body" style="max-height: 400px; overflow-y: auto;">
        <% if (recentContacts && recentContacts.length) { %>
          <div class="list-group list-group-flush">
            <% recentContacts.forEach(contact => { %>
              <a href="/admin/contacts/<%= contact._id %>" class="list-group-item list-group-item-action <%= !contact.isRead ? 'bg-warning bg-opacity-10' : '' %>">
                <div class="d-flex w-100 justify-content-between">
                  <h6 class="mb-1"><%= contact.name %></h6>
                  <small class="text-muted"><%= new Date(contact.createdAt).toLocaleDateString() %></small>
                </div>
                <p class="mb-1 text-muted small">
                  <i class="bi bi-geo-alt"></i> <%= contact.town %>
                  <% if (contact.email) { %>
                    | <i class="bi bi-envelope"></i> <%= contact.email %>
                  <% } %>
                </p>
                <small class="text-muted">
                  <span class="badge bg-info"><%= contact.projectType %></span>
                  <% if (!contact.isRead) { %>
                    <span class="badge bg-warning">New</span>
                  <% } %>
                </small>
              </a>
            <% }) %>
          </div>
        <% } else { %>
          <p class="text-muted text-center py-3">No contacts yet.</p>
        <% } %>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h2 class="h5 mb-0">Recent Sales</h2>
        <a href="/admin/sales" class="btn btn-sm btn-outline-secondary">View All</a>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover table-sm">
            <thead>
              <tr>
                <th>Date</th>
                <th>Customer</th>
                <th>Products</th>
                <th>Total</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% if (recentSales && recentSales.length) { %>
                <% recentSales.forEach(sale => { %>
                  <tr>
                    <td><%= new Date(sale.saleDate).toLocaleDateString() %></td>
                    <td><%= sale.customer ? sale.customer.name : 'N/A' %></td>
                    <td>
                      <% if (sale.lineItems && sale.lineItems.length > 0) { %>
                        <% if (sale.lineItems.length === 1) { %>
                          <%= sale.lineItems[0].product ? sale.lineItems[0].product.name : 'N/A' %>
                        <% } else { %>
                          <%= sale.lineItems.length %> products
                        <% } %>
                      <% } else if (sale.product) { %>
                        <%= sale.product.name %>
                      <% } else { %>
                        N/A
                      <% } %>
                    </td>
                    <td><strong>$<%= (sale.total || sale.amount || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></strong></td>
                    <td>
                      <% if (sale.isPaid) { %>
                        <span class="badge bg-success">Paid</span>
                      <% } else { %>
                        <span class="badge bg-warning">Unpaid</span>
                      <% } %>
                    </td>
                    <td>
                      <a href="/admin/sales/<%= sale._id %>" class="btn btn-sm btn-outline-primary">
                        View
                      </a>
                    </td>
                  </tr>
                <% }) %>
              <% } else { %>
                <tr>
                  <td colspan="6" class="text-center text-muted">No sales yet.</td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card">
      <div class="card-body">
        <h2 class="h5">Quick Links</h2>
        <div class="d-flex flex-wrap gap-2">
          <a href="/admin/products/new" class="btn btn-outline-primary">
            <i class="bi bi-plus-circle"></i> Add Product
          </a>
          <a href="/admin/projects/new" class="btn btn-outline-primary">
            <i class="bi bi-plus-circle"></i> Add Project
          </a>
          <a href="/admin/services/new" class="btn btn-outline-primary">
            <i class="bi bi-plus-circle"></i> Add Service
          </a>
          <a href="/admin/customers/new" class="btn btn-outline-primary">
            <i class="bi bi-person-plus"></i> Add Customer
          </a>
          <a href="/admin/sales/new" class="btn btn-outline-primary">
            <i class="bi bi-cash-stack"></i> Add Sale
          </a>
          <a href="/admin/settings" class="btn btn-outline-primary">
            <i class="bi bi-gear"></i> Settings
          </a>
          <a href="/admin/media" class="btn btn-outline-primary">
            <i class="bi bi-images"></i> Media Upload
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
  let monthlyChart = null;
  let yearlyChart = null;
  
  const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  
  // Load charts on page load
  document.addEventListener('DOMContentLoaded', function() {
    loadMonthlyChart();
    loadYearlyChart();
    
    // Add event listeners for filters
    document.getElementById('filterCustomer').addEventListener('change', updateCharts);
    document.getElementById('filterSale').addEventListener('change', updateCharts);
    document.getElementById('filterYear').addEventListener('change', updateCharts);
    
    // Update charts when switching tabs
    document.getElementById('monthly-tab').addEventListener('shown.bs.tab', function() {
      if (!monthlyChart) loadMonthlyChart();
    });
    document.getElementById('yearly-tab').addEventListener('shown.bs.tab', function() {
      if (!yearlyChart) loadYearlyChart();
    });
  });
  
  function getFilterParams() {
    return {
      customerId: document.getElementById('filterCustomer').value || '',
      saleId: document.getElementById('filterSale').value || '',
      year: document.getElementById('filterYear').value || '',
    };
  }
  
  function clearFilters() {
    document.getElementById('filterCustomer').value = '';
    document.getElementById('filterSale').value = '';
    document.getElementById('filterYear').value = '';
    updateCharts();
  }
  
  function updateCharts() {
    if (monthlyChart) {
      loadMonthlyChart();
    }
    if (yearlyChart) {
      loadYearlyChart();
    }
  }
  
  async function loadMonthlyChart() {
    const params = getFilterParams();
    const queryString = new URLSearchParams(params).toString();
    
    try {
      const response = await fetch(`/admin/api/profit-by-month?${queryString}`);
      const data = await response.json();
      
      // Process data for chart
      const labels = [];
      const profits = [];
      
      // Get all months in the data range
      const monthsMap = new Map();
      data.forEach(item => {
        const key = `${item._id.year}-${item._id.month}`;
        monthsMap.set(key, item.totalProfit);
      });
      
      // Determine date range
      let startYear = params.year ? parseInt(params.year) : new Date().getFullYear() - 1;
      let endYear = params.year ? parseInt(params.year) : new Date().getFullYear();
      
      if (!params.year) {
        // Find min/max years from data
        if (data.length > 0) {
          startYear = Math.min(...data.map(d => d._id.year));
          endYear = Math.max(...data.map(d => d._id.year));
        }
      }
      
      // Generate labels and data
      if (params.year) {
        // If year is specified, show all 12 months for that year
        for (let month = 1; month <= 12; month++) {
          const key = `${startYear}-${month}`;
          labels.push(`${monthNames[month - 1]} ${startYear}`);
          profits.push(monthsMap.get(key) || 0);
        }
      } else {
        // Show all months in the data range
        for (let year = startYear; year <= endYear; year++) {
          for (let month = 1; month <= 12; month++) {
            const key = `${year}-${month}`;
            if (monthsMap.has(key)) {
              labels.push(`${monthNames[month - 1]} ${year}`);
              profits.push(monthsMap.get(key) || 0);
            }
          }
        }
      }
      
      // Show/hide no data message
      const hasData = labels.length > 0 && profits.some(p => p !== 0);
      document.getElementById('monthlyChartContainer').style.display = hasData ? 'block' : 'none';
      document.getElementById('monthlyNoData').style.display = hasData ? 'none' : 'block';
      
      if (!hasData) {
        if (monthlyChart) {
          monthlyChart.destroy();
          monthlyChart = null;
        }
        return;
      }
      
      const ctx = document.getElementById('monthlyProfitChart');
      if (monthlyChart) {
        monthlyChart.destroy();
      }
      
      monthlyChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Profit ($)',
            data: profits,
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: true
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return 'Profit: $' + context.parsed.y.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '$' + value.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                }
              }
            }
          }
        }
      });
    } catch (error) {
      console.error('Error loading monthly chart:', error);
    }
  }
  
  async function loadYearlyChart() {
    const params = getFilterParams();
    const queryString = new URLSearchParams(params).toString();
    
    try {
      const response = await fetch(`/admin/api/profit-by-year?${queryString}`);
      const data = await response.json();
      
      // Process data for chart
      const labels = data.map(item => item._id.toString());
      const profits = data.map(item => item.totalProfit || 0);
      
      // Show/hide no data message
      const hasData = labels.length > 0 && profits.some(p => p !== 0);
      document.getElementById('yearlyChartContainer').style.display = hasData ? 'block' : 'none';
      document.getElementById('yearlyNoData').style.display = hasData ? 'none' : 'block';
      
      if (!hasData) {
        if (yearlyChart) {
          yearlyChart.destroy();
          yearlyChart = null;
        }
        return;
      }
      
      const ctx = document.getElementById('yearlyProfitChart');
      if (yearlyChart) {
        yearlyChart.destroy();
      }
      
      yearlyChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Profit ($)',
            data: profits,
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: true
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return 'Profit: $' + context.parsed.y.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '$' + value.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                }
              }
            }
          }
        }
      });
    } catch (error) {
      console.error('Error loading yearly chart:', error);
    }
  }
</script>

<%- include('../partials/admin-footer') %>
